---
version: 1
interactions:
# requests to retrieve the user from auth service, given his/her ID
- request:
    method: GET
    url: http://authservice/api/users/38b33b8b-996d-4ba4-b565-f32a526de85c
    headers:
      sub: ["tenant_service"] # will be compared against the `sub` claim in the incoming request's token
  response:
    status: 200 OK
    code: 200
    body: '{ 
      "data": {
        "attributes": {
          "username": "user_foo2",
          "email": "user_foo2@bar.com",
      	  "cluster": "http://api.cluster1/"
        }
      }
    }'

# requests to retrieve the list of clusters configured in `auth` service
- request:
    method: GET
    url: http://authservice/api/clusters/
    headers:
      sub: ["tenant_service"] # will be compared against the `sub` claim in the incoming request's token
  response:
    status: 200 OK
    code: 200
    body: '{
      "data":[
        {
          "name": "cluster_name",
          "api-url": "http://api.cluster1/",
          "console-url": "http://console.cluster1/",
          "metrics-url": "http://metrics.cluster1/",
          "logging-url": "http://logs.cluster1/",
          "app-dns": "foo"
        }
      ]
    }'

# requests to resolve the user's token on his/her target cluster
- request:
    method: GET
    url: http://authservice/api/token?for=http%3A%2F%2Fapi.cluster1%2F&force_pull=false
    headers:
      sub: ["tenant_service"] # will be compared against the `sub` claim in the incoming request's token
  response:
    status: 200 OK
    code: 200
    # response with encrypted token for the "tenant service" account
    body: '{ 
			"token_type": "bearer",
			"username": "devtools-sre",
      "access_token": "jA0ECQMCWbHrs0GtZQlg0sDQAYMwVoNofrjMocCLv5+FR4GkCPEOiKvK6ifRVsZ6VWLcBVF5k/MFO0Y3EmE8O77xDFRvA9AVPETb7M873tGXMEmqFjgpWvppN81zgmk/enaeJbTBeYhXScyShw7G7kIbgaRy2ufPzVj7f2muM0PHRS334xOVtWZIuaq4lP7EZvW4u0JinSVT0oIHBoCKDFlMlNS1sTygewyI3QOX1quLEEhaDr6/eTG66aTfqMYZQpM4B+m78mi02GLPx3Z24DpjzgshagmGQ8f2kj49QA0LbbFaCUvpqlyStkXNwFm7z+Vuefpp+XYGbD+8MfOKsQxDr7S6ziEdjs+zt/QAr1ZZyoPsC4TaE6kkY1JHIIcrdO5YoX6mbxDMdkLY1ybMN+qMNKtVW4eV9eh34fZKUJ6sjTfdaZ8DjN+rGDKMtZDqwa1h+YYz938jl/bRBEQjK479o7Y6Iu/v4Rwn4YjM4YGjlXs/T/rUO1uye3AWmVNFfi6GtqNpbsKEbkr80WKOOWiSuYeZHbXA7pWMit17U9LtUA=="
    }'
- request:
    method: GET
    url: http://authservice/api/token?for=http%3A%2F%2Fapi.cluster1%2F&force_pull=false
    headers:
      sub: ["38b33b8b-996d-4ba4-b565-f32a526de85c"] # will be compared against the `sub` claim in the incoming request's token
  response:
    status: 200 OK
    code: 200
    # response with plaintext token for the "user" account
    body: '{ 
      "token_type": "bearer",
      "username": "user_foo2",
      "access_token": "eyJhbGciOiJSUzUxMiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6InVzZXJfZm9vMkBiYXIuY29tIiwic3ViIjoiMzhiMzNiOGItOTk2ZC00YmE0LWI1NjUtZjMyYTUyNmRlODVjIn0.C2vhwU8u-4dflxCvANRYM4YhbxGkQ_VSHgRCoTqNAws-tqs9lD-IHRFNVE5EAz_4ZbPlV_rm3PyuWhUlJRFsItGBAM7Uz8nmRDQlC23QZtJ5FpS1NI_45pYpqFe1VG5DgmyaXGOjrCtdjSgejT7WRGIZM11gFiO-tizyfr6uZKJ-OfMgynQHXrMEhBFnEW6uFRKnzqcQBmIkvn2on1rk7EbCvmzhVM6LlBbPElKTgt94asVAateVPFAVSMXqDiDQCsxYYmsFhxDXPYUjMJabkXQitInyHQeRjhFF9giB0fg57aZ-tOJRBzhm2W7fGXoDC3f_u2VV4kVWF8EhL5I"
    }'

# requests to verify that the token is still valid, using the `whoami` API on the user's target cluster
- request:
    method: GET
    url: http://api.cluster1/apis/user.openshift.io/v1/users/~
    headers:
      sub: ["devtools-sre"] # will be compared against the `sub` claim in the incoming request's token
  response:
    status: 200 OK
    code: 200
    body: '{
      "kind":"User",
      "apiVersion":"user.openshift.io/v1",
      "metadata":{
        "name":"devtools-sre",
      },
      "identities":[],
      "groups":[]
    }'

# requests to retrieve the user's list of projects on OSO
- request:
    method: GET
    url: http://api.cluster1/oapi/v1/projects
    headers:
      sub: ["38b33b8b-996d-4ba4-b565-f32a526de85c"] # will be compared against the `sub` claim in the incoming request's token
  response:
    status: 200 OK
    code: 200
    body: '{
      "kind": "ProjectList",
      "apiVersion": "v1",
      "metadata": {
        "selfLink": "/oapi/v1/projects"
      },
      "items": [
        {
          "metadata": {
            "name": "foo1",
            "selfLink": "/oapi/v1/projects/foo1",
            "uid": "51e07e7a-1597-11e7-ad87-0000000000001",
            "resourceVersion": "0",
            "creationTimestamp": "2017-03-30T22:22:11Z",
            "annotations": {
              "openshift.io/description": "",
              "openshift.io/display-name": "",
            }
          },
          "spec": {
            "finalizers": [
              "openshift.io/origin",
              "kubernetes"
            ]
          },
          "status": {
            "phase": "Active"
          }
        },
        {
          "metadata": {
            "name": "foo2",
            "selfLink": "/oapi/v1/projects/foo2",
            "uid": "51e07e7a-1597-11e7-ad87-0000000000001",
            "resourceVersion": "0",
            "creationTimestamp": "2017-03-30T22:22:11Z",
            "annotations": {
              "openshift.io/description": "",
              "openshift.io/display-name": "",
            }
          },
          "spec": {
            "finalizers": [
              "openshift.io/origin",
              "kubernetes"
            ]
          },
          "status": {
            "phase": "Active"
          }
        }
      ]
    }'
- request:
    method: GET
    url: http://api.cluster1/oapi/v1/projects
    headers:
      sub: ["da6d50b9-0086-4aec-9fcd-2882c09ea53b"] # will be compared against the `sub` claim in the incoming request's token
  response:
    status: 200 OK
    code: 200
    body: '{
      "kind": "ProjectList",
      "apiVersion": "v1",
      "metadata": {
        "selfLink": "/oapi/v1/projects"
      },
      "items": [
        {
          "metadata": {
            "name": "foo1",
            "selfLink": "/oapi/v1/projects/foo1",
            "uid": "51e07e7a-1597-11e7-ad87-0000000000001",
            "resourceVersion": "0",
            "creationTimestamp": "2017-03-30T22:22:11Z",
            "annotations": {
              "openshift.io/description": "",
              "openshift.io/display-name": "",
            }
          },
          "spec": {
            "finalizers": [
              "openshift.io/origin",
              "kubernetes"
            ]
          },
          "status": {
            "phase": "Active"
          }
        },
        {
          "metadata": {
            "name": "foo2",
            "selfLink": "/oapi/v1/projects/foo2",
            "uid": "51e07e7a-1597-11e7-ad87-0000000000001",
            "resourceVersion": "0",
            "creationTimestamp": "2017-03-30T22:22:11Z",
            "annotations": {
              "openshift.io/description": "",
              "openshift.io/display-name": "",
            }
          },
          "spec": {
            "finalizers": [
              "openshift.io/origin",
              "kubernetes"
            ]
          },
          "status": {
            "phase": "Active"
          }
        }
      ]
    }'
- request:
    method: GET
    url: http://api.cluster1/oapi/v1/projects
    headers:
      sub: ["02a6474c-3b04-4dc4-bfd2-4867102581e0"] # will be compared against the `sub` claim in the incoming request's token
  response:
    status: 200 OK
    code: 200
    body: '{
      "kind": "ProjectList",
      "apiVersion": "v1",
      "metadata": {
        "selfLink": "/oapi/v1/projects"
      },
      "items": [
        {
          "metadata": {
            "name": "foo1",
            "selfLink": "/oapi/v1/projects/foo1",
            "uid": "51e07e7a-1597-11e7-ad87-0000000000001",
            "resourceVersion": "0",
            "creationTimestamp": "2017-03-30T22:22:11Z",
            "annotations": {
              "openshift.io/description": "",
              "openshift.io/display-name": "",
            }
          },
          "spec": {
            "finalizers": [
              "openshift.io/origin",
              "kubernetes"
            ]
          },
          "status": {
            "phase": "Active"
          }
        }
      ]
    }'
- request:
    method: GET
    url: http://api.cluster1/oapi/v1/projects
    headers:
      sub: ["0443beeb-1cfb-427f-bd7c-d22d941bea4f"] # will be compared against the `sub` claim in the incoming request's token
  response:
    status: 200 OK
    code: 200
    body: '{
      "kind": "ProjectList",
      "apiVersion": "v1",
      "metadata": {
        "selfLink": "/oapi/v1/projects"
      },
      "items": [
        {
          "metadata": {
            "name": "foo1",
            "selfLink": "/oapi/v1/projects/foo1",
            "uid": "51e07e7a-1597-11e7-ad87-0000000000001",
            "resourceVersion": "0",
            "creationTimestamp": "2017-03-30T22:22:11Z",
            "annotations": {
              "openshift.io/description": "",
              "openshift.io/display-name": "",
            }
          },
          "spec": {
            "finalizers": [
              "openshift.io/origin",
              "kubernetes"
            ]
          },
          "status": {
            "phase": "Active"
          }
        }
      ]
    }'

# set of requests for the init tenant API calls on the target (OSO) cluster for user 38b33b8b-996d-4ba4-b565-f32a526de85c
- request:
    method: POST
    url: http://api.cluster1/oapi/v1/projectrequests
    headers:
      sub: ["38b33b8b-996d-4ba4-b565-f32a526de85c"] # will be compared against the `sub` claim in the incoming request's token
  response:
    status: 403 Forbidden
    code: 403
    body: |
      apiVersion: v1
      metadata: {}
      code: 403
      details:
        kind: projectrequests
        name: user-foo
      kind: Status
      message: "projectrequests \"user-foo\" is forbidden: user user-foo cannot create more than 1 project(s)."
      reason: Forbidden
      status: Failure
